<!DOCTYPE html>
<html>
    <head>
        <title>Youth Tech Prototype</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <link href="css/site.css" type="text/css" rel="stylesheet" />
    </head>
    <body>
        <div id="mapCanvas"></div>

        <div id="stopsList" data-bind="visible: hasStops">
            <ol data-bind="foreach: stops">
                <li>
                    <h3 data-bind="text: properties.stop_name"></h3>
                    <p data-bind="text: properties.stop_desc"></p>
                    <p data-bind="text: title"></p>
                </li>
            </ol>
            <p>Average distance: <span data-bind="text: averageDistance"></span> feet</p>
        </div>

        <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry" type="text/javascript"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js" type="text/javascript"></script>
        <script src="js/mapping.js" type="text/javascript"></script>
        <script src="js/databinding.js" type="text/javascript"></script>

        <script type="text/javascript">
            $(document).ready(function() {
                var listTarget = document.getElementById("stopsList");
                var mapTarget = document.getElementById("mapCanvas");

                navigator.geolocation.getCurrentPosition(function (position) {
                    var map = initializeMap(mapTarget, position);
                    var mapCenter = map.getCenter();

                    $.getJSON("data/busstops.geojson", function (stopsJSON) {
                        var stopsWithDistance = computeDistance(stopsJSON, mapCenter);
                        stopsWithDistance.features.sort(compareDistance);

                        var stopListViewModel = new stopsViewModel();

                        for (var index = 0; index < 5; index++) {
                            var feature = stopsWithDistance.features[index];
                            feature.title = "distance = " + feature.distance + " feet";

                            addMarker(map, feature.LatLng, feature.title);

                            stopListViewModel.addStop(feature);
                        }

                        ko.applyBindings(stopListViewModel, listTarget);
                    });
                });
            });
        </script>

    </body>
</html>
